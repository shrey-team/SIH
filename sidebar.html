<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jharkhand Map ‚Äî Issues</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body { display: flex; flex-direction: column; }

    .sidebar-header { display: flex; justify-content: space-between; align-items: center; }
    .back-btn a {
      text-decoration: none;
      background: #0077b6; color: #fff;
      padding: 4px 10px; border-radius: 6px;
      font-size: 0.8rem; font-weight: bold;
      transition: background 0.3s ease, transform 0.2s ease;
      animation: pulse 1.8s infinite;
    }
    .back-btn a:hover { background: #005f87; transform: scale(1.05); }
    .back-btn a:active { background: #004466; transform: scale(0.98); }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 119, 182, 0.6); }
      70% { box-shadow: 0 0 0 20px rgba(0, 119, 182, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 119, 182, 0); }
    }

    #container { display: flex; height: 100vh; width: 100%; }
    #sidebar { width: 300px; background: #f8f8f8; padding: 10px; overflow-y: auto; border-right: 1px solid #ddd; z-index: 500; }
    #sidebar h3 { margin-top: 0; }
    .report { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; }
    .report:hover { background: #eee; }
    #map { flex: 1; }

    /* ‚≠ê Vote UI */
    .vote-controls { margin-top: 5px; display: flex; gap: 6px; align-items: center; }
    .vote-btn { cursor: pointer; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; background: #fff; }
    .vote-btn:hover { background: #eee; }
    .vote-count { font-size: 0.85rem; color: #333; }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <div class="sidebar-header">
        <h3>Service Requests</h3>
        <div class="back-btn">
          <a href="home.html">‚¨Ö Back to Home</a>
        </div>
      </div>
      <div id="reportList"></div>
    </div>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <script>
    // Center of Jharkhand
    const jharkhandCenter = [23.6102, 85.2799];
    const map = L.map('map').setView(jharkhandCenter, 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Show user's location
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        L.marker([lat, lon]).addTo(map).bindPopup("üìç You are here").openPopup();
        L.circle([lat, lon], { radius: acc }).addTo(map);
        map.setView([lat, lon], 13);
      },
      err => { console.warn("Could not fetch your location: " + err.message); },
      { enableHighAccuracy: true, timeout: 10000 }
    );

    // Supabase setup
    const supabaseUrl = "https://lxclfklnpktmvtgkpkgg.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4Y2xma2xucGt0bXZ0Z2twa2dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyODExNTEsImV4cCI6MjA3Mzg1NzE1MX0.qaAtZrCKsk9w_kIE3A6wX2_U4NAafIaC-pWhPcu3Fzc"; // ‚≠ê replace with anon key
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

     // ‚≠ê generate anonymous ID if not already stored
  let anonId = localStorage.getItem("anon_id");
  if (!anonId) {
    anonId = crypto.randomUUID();
    localStorage.setItem("anon_id", anonId);
  }

  const colors = { Pothole:'brown', Water:'blue', Waste:'green', Streetlight:'yellow', Other:'red' };
  const reportList = document.getElementById('reportList');

  // ‚≠ê Get votes for one complaint
  async function getVoteCount(complaintId) {
    let { data, error } = await supabase.from("votes").select("vote").eq("complaint_id", complaintId);
    if (error) return 0;
    return data.reduce((sum, v) => sum + v.vote, 0);
  }

  // ‚≠ê Handle voting
  async function handleVote(complaintId, value) {
    const { error } = await supabase.from("votes")
      .upsert({ complaint_id: complaintId, user_id: anonId, vote: value }, { onConflict: "complaint_id,user_id" });

    if (error) console.error("Vote error:", error);
    else loadReports(); // refresh sidebar
  }

  async function loadReports() {
    reportList.innerHTML = "";
    const { data, error } = await supabase.from("complaints").select("*").order("created_at", { ascending: false });
    if (error) { console.error("Error fetching complaints:", error); return; }

    for (let report of data) {
      const score = await getVoteCount(report.id);

      // Sidebar entry with votes
      const div = document.createElement('div');
      div.className = 'report';
      div.innerHTML = `
        <b>${report.issue_type}</b><br>
        ${report.description || "No description"}<br>
        <small>${report.location_text || ""}</small><br>
        <small>Status: ${report.status || "Pending"}</small>
        <div class="vote-controls">
          <button class="vote-btn" onclick="handleVote(${report.id},1)">‚¨Ü</button>
          <button class="vote-btn" onclick="handleVote(${report.id},-1)">‚¨á</button>
          <span class="vote-count">Score: ${score}</span>
        </div>
      `;
      reportList.appendChild(div);

      // Marker
      if (report.latitude && report.longitude) {
        const marker = L.circleMarker([report.latitude, report.longitude], {
          radius: 8, fillColor: colors[report.issue_type] || 'gray',
          color: '#000', weight: 1, opacity: 1, fillOpacity: 0.8
        }).addTo(map);

        let popupContent = `
          <b>${report.issue_type}</b><br>
          ${report.description || "No description"}<br>
          <small>${report.location_text || ""}</small><br>
          <small>Pincode: ${report.pincode || ""}</small><br>
          <small>Status: ${report.status || "Pending"}</small><br>
          <div class="vote-controls">
            <button class="vote-btn" onclick="handleVote(${report.id},1)">‚¨Ü</button>
            <button class="vote-btn" onclick="handleVote(${report.id},-1)">‚¨á</button>
            <span class="vote-count">Score: ${score}</span>
          </div>
        `;

        if (report.image_urls) {
          popupContent += `<img src="${report.image_urls}" alt="issue image" width="120" style="margin-top:5px;border-radius:4px;">`;
        }

        marker.bindPopup(popupContent);
        div.addEventListener('click', () => { map.setView([report.latitude, report.longitude], 15); marker.openPopup(); });
      }
    }
  }

    loadReports();
  </script>
</body>
</html>
